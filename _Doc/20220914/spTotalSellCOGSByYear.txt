USE [BS]
GO

/****** Object:  StoredProcedure [dbo].[spTotalSellCOGSByYear]    Script Date: 9/20/2022 4:29:57 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




CREATE PROCEDURE [dbo].[spTotalSellCOGSByYear] 
 @YearList NVARCHAR(MAX) 
 ,@MonthList NVARCHAR(MAX) 
AS
BEGIN
SET NOCOUNT ON;

SELECT OrderYear,ROUND(Cost/1000,2)Cost,ROUND(TotalAmount/1000,2)TotalAmount FROM(
SELECT 
--Orders.OrderID,Orders.OrderCode
--,
year(Orders.OrderDate) as OrderYear
--Product.ProductCategoryID,ProductCategory.NameThai as ProductCategory
--,Product.ProductID,Product.ProductName 
--,Orders.CustomerID,CASE WHEN Customer.CompanyName <>'' THEN Customer.CompanyName ELSE Customer.Title + Customer.Firstname + ' ' + Customer.LastName END Customer 
--,SUM(ProductList.PriceMain* ProductList.RateUnit)   AS Price
,SUM(ProductList.Cost * ProductList.RateUnit) AS Cost
--,SUM((ProductList.PriceMain-ProductList.Cost) * ProductList.RateUnit) AS TotalGain
,SUM(ProductList.Total) AS TotalAmount
FROM Orders  
--LEFT OUTER JOIN Customer ON Orders.CustomerID=Customer.CustomerID  
LEFT OUTER JOIN ProductList ON Orders.OrderID=ProductList.RefID AND ProductList.IsDelete =0  
--LEFT OUTER JOIN Product ON Product.ProductID=ProductList.ProductID 
--LEFT OUTER JOIN ProductCategory ON Product.ProductCategoryID=ProductCategory.CategoryID
WHERE Orders.IsDelete =0 AND Orders.IsCancel = 0  
and Orders.TableID=39
and year(Orders.OrderDate)in(select val from split(@YearList, ','))
and month(Orders.OrderDate) in(select val from split(@MonthList, ','))
--and Product.ProductCategoryID>0
group by 
--Orders.OrderID,Orders.CustomerID,Orders.OrderCode
--,Customer.CompanyName,Customer.Title,Customer.Firstname,Customer.LastName
--,Product.ProductID,Product.ProductName
--,
year(Orders.OrderDate)
--ORDER BY Orders.OrderCode
--,Customer.CompanyName
--,Customer.Title
--,Customer.Firstname,Customer.LastName
--,Product.ProductName
) as tmp
order by OrderYear 

END
GO


